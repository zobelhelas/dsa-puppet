##
### THIS FILE IS UNDER PUPPET CONTROL. DON'T EDIT IT HERE.
### USE: git clone git+ssh://$USER@puppet.debian.org/srv/puppet.debian.org/git/dsa-puppet.git
###

<%=
nameservers = []
searchpaths = []
options = []

if %w{draghi liszt}.include?(hostname)
  nameservers << "127.0.0.1"
end

nameservers += scope.lookupvar('ns')
options += scope.lookupvar('site::nodeinfo')['hoster']['resolvoptions'] if scope.lookupvar('site::nodeinfo')['hoster']['resolvoptions']

searchpaths << "debian.org"
searchpaths += scope.lookupvar('sp')

resolvconf  = ''
resolvconf += "search " + searchpaths.to_a.flatten.join(" ") + "\n"

if has_variable?('unbound') and unbound and unbound == "true"
  resolvconf += "nameserver 127.0.0.1\n"
else
  if nameservers.empty?
    #raise Puppet::ParseError, "Something has gone wrong writing resolv.conf.  No nameservers to use!"
    scope.function_warning(["Something has gone wrong writing resolv.conf.  No nameservers to use - using google's!"])
    nameservers << '8.8.8.8'
    nameservers << '8.8.4.4'
  end

  nameservers.to_a.flatten.each do |ns|
    resolvconf += "nameserver " + ns + "\n"
  end
end

options.each do |opt|
  resolvconf += "options " + opt + "\n"
end

resolvconf
%>
