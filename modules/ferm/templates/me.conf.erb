##
## THIS FILE IS UNDER PUPPET CONTROL. DON'T EDIT IT HERE.
## USE: git clone git+ssh://$USER@puppet.debian.org/srv/puppet.debian.org/git/dsa-puppet.git
##

<%=
nodeinfo = scope.lookupvar('site::nodeinfo')
out = []

restricted_purposes = ['kvm host', 'central syslog server', 'puppet master', 'jumphost']
restrict_ssh = %w{lebrun beethoven tchaikovsky schroeder draghi adayevskaya}

if (nodeinfo['ldap'].has_key?('purpose')) then
	nodeinfo['ldap']['purpose'].each do |purp|
		if restricted_purposes.include?(purp) then
			restrict_ssh << hostname
		end
	end
end

ssh4allowed = []
ssh6allowed = []

should_restrict = restrict_ssh.include?(hostname)
%w{dns_primary dns_geo}.each do |role_restrict|
	if scope.function_has_role([role_restrict]) then
		should_restrict = true
	end
end


if restrict_ssh.include?(hostname) then
	ssh4allowed << %w{$DSA_IPS    $HOST_NAGIOS_V4 $HOST_MUNIN_V4 $HOST_DB_V4}
	ssh6allowed << %w{$DSA_V6_IPS $HOST_NAGIOS_V6 $HOST_MUNIN_V6 $HOST_DB_V6}

	if %w{lebrun schroeder}.include?(hostname) then
		out << '@def $CARNET = ( 193.198.184.8/29 161.53.160.133 161.53.160.90 161.53.11.222 161.53.12.134 161.53.12.142 161.53.12.143 );'
		ssh4allowed << '$CARNET'
		ssh4allowed << '$BUILDD_SSH_ACCESS'
	end
	if %w{beethoven draghi}.include?(hostname) then
		ssh4allowed << '$HOST_DEBIAN_V4'
		ssh6allowed << '$HOST_DEBIAN_V6'
	end

	if %w{adayevskaya}.include?(hostname) then
		ssh4allowed << %w{$HOST_DEBIAN_V4}
		ssh6allowed << %w{$HOST_DEBIAN_V6}
	end
	if scope.function_has_role(['dns_primary']) then
		ssh4allowed << "5.153.231.5" # adayevskaya
		ssh6allowed << "2001:41c8:1000:21::21:5" # adayevskaya
		#ssh4allowed << "$HOST_DNS_GEO_V4"
		#ssh6allowed << "$HOST_DNS_GEO_V6"
	end

	if scope.function_has_role(['static_master']) then
		ssh4allowed << '$HOST_STATIC_V4'
		ssh6allowed << '$HOST_STATIC_V6'
	elsif scope.function_has_role(['static_source']) or
	      scope.function_has_role(['static_mirror']) then
		ssh4allowed << '$HOST_STATICMASTER_V4'
		ssh6allowed << '$HOST_STATICMASTER_V6'
	end
end
ssh4allowed.length == 0 and ssh4allowed << '0.0.0.0/0'
ssh6allowed.length == 0 and ssh6allowed << '::/0'

out << "@def $SSH_SOURCES    = (#{ssh4allowed.join(' ')});"
out << "@def $SSH_V6_SOURCES = (#{ssh6allowed.join(' ')});"




smtp4allowed = []
smtp6allowed = []

if not nodeinfo['smarthost'].empty?
  smtp4allowed << %w{$HOST_MAILRELAY_V4 $HOST_NAGIOS_V4}
  smtp6allowed << %w{$HOST_MAILRELAY_V6 $HOST_NAGIOS_V6}
end

smtp4allowed.length == 0 and smtp4allowed << '0.0.0.0/0'
smtp6allowed.length == 0 and smtp6allowed << '::/0'

out << "@def $SMTP_SOURCES    = (#{smtp4allowed.join(' ')});"
out << "@def $SMTP_V6_SOURCES = (#{smtp6allowed.join(' ')});"

out.join("\n")
%>
