#!/bin/bash

set -e

. common.sh

CLEANUP=( )
set -x
trap cleanup EXIT

if [ -z "$TARGET" -o ! -d "$TARGET" ]; then
  echo "Missing target directory"
  exit 1
fi

# allow extlinux to find device
mount --bind /dev $TARGET/dev
CLEANUP+=("umount $TARGET/dev")
mount --bind /proc $TARGET/proc
CLEANUP+=("umount $TARGET/proc")

# generate configuration
echo 'EXTLINUX_PARAMETERS="ro console=ttyS0,38400n8"' > $TARGET/etc/default/extlinux
chroot "$TARGET" extlinux-update

# install extlinux
chroot "$TARGET" extlinux -i /boot/extlinux

# install boot record
dd if="$TARGET/usr/lib/extlinux/mbr.bin" of=$BLOCKDEV

cleanup
trap - EXIT

exit 0
