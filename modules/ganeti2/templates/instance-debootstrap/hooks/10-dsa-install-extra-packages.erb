#!/bin/bash

set -e

if [ -z "$TARGET" -o ! -d "$TARGET" ]; then
  echo "Missing target directory"
  exit 1
fi

chroot "$TARGET" apt-get -qq update
chroot "$TARGET" apt-get -qq install vim ssh extlinux

node="$(hostname)"
instance="$(cat $TARGET/etc/hostname)"
sed -e "s#root@$node#root@$instance#" -i "$TARGET"/etc/ssh/ssh*pub

if [ "$ARCH" = "amd64" ]; then
    chroot "$TARGET" apt-get -qq install linux-image-amd64
fi

exit 0
