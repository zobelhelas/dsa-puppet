##
## THIS FILE IS UNDER PUPPET CONTROL. DON'T EDIT IT HERE.
## USE: git clone git+ssh://$USER@puppet.debian.org/srv/puppet.debian.org/git/dsa-puppet.git
##

<%=

lines = []

lines << "# This file has been autogenerated and pushed by puppet.  Edit static-components.yaml in puppet."
lines << "# <master> <service> <source host> <directory> <extra push hosts, comma separated> <hosts to not mirror this component to>"


config = YAML.load(File.open('/etc/puppet/modules/roles/misc/static-components.yaml').read)
mirrors = scope.lookupvar('site::roles')['static_mirror']

config['components'].each_pair do |component, conf|
	%w{exclude-mirrors extra-push limit-mirrors}.each do |key|
		conf[key] = [] unless conf.has_key?(key)
	end

	srchost, srcpath = conf['source'].split(':', 2)

	config['mirrors'].each do |mirror, mc|
		next unless mirrors.include?(mirror)

		if mc.has_key?('components-include') and not mc['components-include'].include?(component)
			conf['exclude-mirrors'] << mirror
		end
	end
	if conf['limit-mirrors'].size > 0
		mirrors.each do |mirror|
			if not conf['limit-mirrors'].include?(mirror)
				next if conf['exclude-mirrors'].include?(mirror) # if it's already excluded, do not add it again
				conf['exclude-mirrors'] << mirror
			end
		end
	end

	exclude = conf['exclude-mirrors'].join(',')
	exclude = '-' unless exclude != ""
	extrapush = conf['extra-push'].join(',')
	extrapush = '-' unless extrapush != ""

	lines << "#{conf['master']} #{component} #{srchost} #{srcpath} #{extrapush} #{exclude}"
end
lines.join("\n")
%>
