# puppet maintained

######################
# deb.debian.org
<% if scope.function_has_static_component(['deb.debian.org']) -%>
<Macro vhost-deb.debian.org-extra>
	Redirect /debian/           http://cdn-fastly.deb.debian.org/debian/
	Redirect /debian-debug/     http://cdn-fastly.deb.debian.org/debian-debug/
	Redirect /debian-ports/     http://cdn-fastly.deb.debian.org/debian-ports/
	Redirect /debian-security/  http://cdn-fastly.deb.debian.org/debian-security/
</Macro>
<% end -%>


<%=

def vhost(lines, sn, type=nil, extra=nil)
  if scope.function_has_static_component([sn])
    t = 'common-static-vhost'
    if type then t += "-#{type}"; end

    e = ''
    if extra then e += " #{extra}"; end

    lines << "Use #{t} #{sn}#{e}"
  end
end

lines = []
vhost(lines, "mozilla.debian.net")
vhost(lines, "backports.debian.org", "ssl")
vhost(lines, "incoming.debian.org")
vhost(lines, "incoming.ports.debian.org")
vhost(lines, "debdeltas.debian.net")
vhost(lines, "news.debian.net"         , "ssl")
vhost(lines, "debaday.debian.net"      , "ssl")
vhost(lines, "timeline.debian.net"     , "ssl")
vhost(lines, "network-test.debian.org" , "with-extra", '"ServerAlias network-test-backend.debian.org"')
vhost(lines, "blends.debian.org"       , "with-extra", '"ServerAlias blends-backend.debian.org"')
vhost(lines, "wnpp-by-tags.debian.net" , "with-extra", '"ServerAlias wnpp-by-tags-backend.debian.org"')
vhost(lines, "security-team.debian.org", "with-extra", '"ServerAlias security-team-backend.debian.org"')
vhost(lines, "d-i.debian.org"      , "ssl")
vhost(lines, "appstream.debian.org", "ssl")
vhost(lines, "dsa.debian.org"      , "ssl")
vhost(lines, "rtc.debian.org"      , "ssl")

vhost(lines, "10years.debconf.org" , "ssl")
vhost(lines, "debconf0.debconf.org", "ssl")
vhost(lines, "debconf1.debconf.org", "ssl")
vhost(lines, "debconf2.debconf.org", "ssl")
vhost(lines, "debconf3.debconf.org", "ssl")
vhost(lines, "debconf4.debconf.org", "ssl")
vhost(lines, "debconf5.debconf.org", "ssl")
vhost(lines, "debconf6.debconf.org", "ssl")
vhost(lines, "debconf7.debconf.org", "ssl")
vhost(lines, "es.debconf.org"      , "ssl")
vhost(lines, "fr.debconf.org"      , "ssl")
vhost(lines, "miniconf10.debconf.org" , "ssl")

vhost(lines, "deb.debian.org", "with-extra", '"Use vhost-deb.debian.org-extra"')

lines.join("\n")
-%>

######################
# metadata.ftp-master.debian.org
<% if scope.function_has_static_component(['metadata.ftp-master.debian.org']) -%>
<VirtualHost <%= vhost_listen %> >
	ServerName metadata.ftp-master.debian.org
	ServerAdmin debian-admin@lists.debian.org

	ErrorLog /var/log/apache2/metadata.ftp-master.debian.org-error.log
	CustomLog /var/log/apache2/metadata.ftp-master.debian.org-access.log privacy

	Use common-static-base metadata.ftp-master.debian.org
	AddDefaultCharset utf-8
	<LocationMatch "/changelogs/(main|contrib|non-free)">
		ForceType text/plain
	</LocationMatch>
</VirtualHost>
<% end -%>

######################
# bits.debian.org
<% if scope.function_has_static_component(['bits.debian.org']) -%>
<Macro static-bits.debian.org-base>
	ServerName bits.debian.org
	ServerAdmin debian-admin@lists.debian.org

	ErrorLog /var/log/apache2/bits.debian.org-error.log
	<IfModule mod_geoip.c>
		CustomLog /var/log/apache2/bits.debian.org-public-access.log privacy+geo
	</IfModule>

	Use common-static-base bits.debian.org
</Macro>

<Virtualhost <%= vhost_listen %> >
	RewriteEngine on

	RewriteEngine On
	RewriteCond %{REQUEST_URI} !^/feeds/
	RewriteRule ^/(.*)$ https://bits.debian.org/$1 [R,L]
	#RewriteRule ^/(.*)$ https://bits.debian.org/$1 [R=301,L]

	Use static-bits.debian.org-base
	CustomLog /var/log/apache2/bits.debian.org-access.log privacy
</VirtualHost>

<Virtualhost <%= vhost_listen_443 %> >
	Use static-bits.debian.org-base
	CustomLog /var/log/apache2/bits.debian.org-access.log privacyssl

	Use common-debian-service-ssl bits.debian.org
	Use common-ssl-HSTS
</VirtualHost>
<% end -%>

# www.backports.org
###################
# www.backports.org is the historical place for the backports
# website and archive.  It is now a CNAME to backports.debian.org:
# redirect http requests.
<VirtualHost <%= vhost_listen %> >
	ServerName www.backports.org
	ServerAlias lists.backports.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / http://backports.debian.org/
</VirtualHost>

######################
# www.ports.debian.org
<% if scope.function_has_static_component(['www.ports.debian.org']) -%>

Use common-dsa-vhost-https-redirect www.ports.debian.org

<Virtualhost <%= vhost_listen_443 %> >
	ServerName www.ports.debian.org
	ServerAlias www.ports-backend.debian.org
	ServerAdmin debian-admin@lists.debian.org

	ErrorLog /var/log/apache2/www.ports.debian.org-error.log
	CustomLog /var/log/apache2/www.ports.debian.org-access.log privacy

	Use common-debian-service-ssl www.ports.debian.org
	Use common-ssl-HSTS

	<IfModule mod_userdir.c>
		UserDir disabled
	</IfModule>
	ServerSignature On

	DocumentRoot /srv/static.debian.org/mirrors/www.ports.debian.org/cur
	<Directory /srv/static.debian.org/mirrors/www.ports.debian.org/cur>
		AllowOverride FileInfo Indexes Options=Multiviews
		Options Multiviews Indexes FollowSymLinks Includes
		IndexOptions FancyIndexing NameWidth=*
		Require all granted
	</Directory>

	AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
	AddOutputFilter INCLUDES .xhtml
</VirtualHost>
<% end -%>

<VirtualHost <%= vhost_listen %> >
	ServerName www.debian-ports.org
	ServerAlias debian-ports.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / https://www.ports.debian.org/
</VirtualHost>

<VirtualHost <%= vhost_listen %> >
	ServerName ports.debian.org
	ServerAlias ports.debian.net
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / https://www.ports.debian.org/
</VirtualHost>

<VirtualHost <%= vhost_listen %> >
	ServerName incoming.debian-ports.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / http://incoming.ports.debian.org/
</VirtualHost>

<VirtualHost <%= vhost_listen %> >
	ServerName ftp.debian-ports.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / http://ftp.ports.debian.org/
</VirtualHost>

# video.debian.net
###################
<VirtualHost <%= vhost_listen %> >
	ServerName video.debian.net
	ServerAdmin debian-admin@debian.org

	Redirect / http://meetings-archive.debian.net/pub/debian-meetings/
</VirtualHost>

# historical sites
##################
# now only redirects remain
<VirtualHost <%= vhost_listen %> >
	ServerName women.debian.org
	ServerAdmin debian-admin@debian.org

	RedirectPermanent / http://www.debian.org/women/

	RedirectPermanent /about/ http://www.debian.org/women/about
	RedirectPermanent /contact/ http://www.debian.org/women/contact
	RedirectPermanent /faqs/ http://www.debian.org/women/faq
	RedirectPermanent /home/ http://www.debian.org/women/
	RedirectPermanent /images/dw.png http://www.debian.org/women/dw.png
	RedirectPermanent /involvement/ http://www.debian.org/women/participate
	RedirectPermanent /mentoring/ http://www.debian.org/women/mentoring
	RedirectPermanent /press/ http://wiki.debian.org/DebianWomen/Press
	RedirectPermanent /profiles/ http://www.debian.org/women/profiles/
</VirtualHost>

<VirtualHost <%= vhost_listen %> >
	ServerName volatile.debian.org
	ServerAlias volatile-master.debian.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / http://www.debian.org/volatile/
</VirtualHost>

<VirtualHost <%= vhost_listen %> >
	ServerName ftp-master.metadata.debian.org
	ServerAdmin debian-admin@debian.org
	RedirectPermanent / http://metadata.ftp-master.debian.org/
</VirtualHost>

# vim:ft=apache:
