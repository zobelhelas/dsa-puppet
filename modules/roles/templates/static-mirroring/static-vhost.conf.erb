# puppet maintained
<Macro common-dsa-vhost-https-redirect $name>
	<VirtualHost <%= vhost_listen %> >
		ServerName $name
		ServerAdmin debian-admin@lists.debian.org

		CustomLog /var/log/apache2/$name-access.log privacy
		ErrorLog /var/log/apache2/$name-error.log

		Redirect permanent / https://$name/
	</VirtualHost>
</Macro>

<Macro common-dsa-vhost-https-redirect-temp $name>
	<VirtualHost <%= vhost_listen %> >
		ServerName $name
		ServerAdmin debian-admin@lists.debian.org

		CustomLog /var/log/apache2/$name-access.log privacy
		ErrorLog /var/log/apache2/$name-error.log

		Redirect / https://$name/
	</VirtualHost>
</Macro>

<Macro common-static-base $name>
	<IfModule mod_userdir.c>
		UserDir disabled
	</IfModule>
	ServerSignature On

	DocumentRoot /srv/static.debian.org/mirrors/$name/cur
	<Directory /srv/static.debian.org/mirrors/$name/cur>
		AllowOverride FileInfo Indexes Options=Multiviews
		Options Indexes SymLinksIfOwnerMatch
		IndexOptions FancyIndexing NameWidth=*
		<% if @lsbmajdistrelease > '7' -%>
			Require all granted
		<% else -%>
			Order allow,deny
			Allow from all
		<% end -%>
	</Directory>

	Header set Surrogate-Key <%= hostname %>

	DefaultType text/plain
	AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
</Macro>


<Macro common-static-vhost-with-extra $name $extra>
	<Virtualhost <%= vhost_listen %> >
		ServerName $name
		ServerAdmin debian-admin@lists.debian.org

		ErrorLog /var/log/apache2/$name-error.log
		CustomLog /var/log/apache2/$name-access.log privacy

		Use common-static-base $name
		$extra
	</VirtualHost>
</Macro>

<Macro common-static-vhost $name>
	Use common-static-vhost-with-extra $name "# nada"
</Macro>


<Macro common-static-vhost-ssl $name>
	Use common-dsa-vhost-https-redirect $name

	<Virtualhost <%= vhost_listen_443 %> >
		ServerName $name
		ServerAdmin debian-admin@lists.debian.org

		ErrorLog /var/log/apache2/$name-error.log
		CustomLog /var/log/apache2/$name-access.log privacyssl

		Use common-debian-service-ssl $name
		Use common-ssl-HSTS

		Use common-static-base $name
	</VirtualHost>
</Macro>

# vim:ft=apache:
